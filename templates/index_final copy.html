<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ü—Ä–æ–¥–∞–∂–∏ ‚Äî —Ñ–∏–ª—å—Ç—Ä</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.0/dist/css/bootstrap-datepicker.min.css" rel="stylesheet">
<style>
body { padding:20px; display:flex; flex-direction:column; height:100vh; }
.scroll-table { flex-grow:1; overflow-y:auto; border:1px solid #dee2e6; border-radius:.5rem; max-height:70vh; }
#data-table thead th { position:sticky; top:0; background:#f8f9fa; z-index:2; }
#data-table thead tr.filter-row th { position:sticky; top:36px; background:#fff; z-index:1; }
th { cursor:pointer; user-select:none; white-space:nowrap; }
#data-table thead tr.filter-row input { width:100%; font-size:12px; padding:2px 4px; }

/* –ú—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç */
.multi-select {
    display:flex; flex-wrap:wrap; align-items:center;
    padding:4px; border:1px solid #ced4da; border-radius:.5rem; min-height:44px;
    cursor:text; position:relative; background:#fff;
    transition: border-color 0.2s, box-shadow 0.2s;
}
.multi-select:focus-within {
    border-color:#0d6efd;
    box-shadow:0 0 0 0.2rem rgba(13,110,253,.25);
}
.multi-select .tag {
    display:flex; align-items:center;
    background:#0d6efd; color:white; padding:4px 6px;
    border-radius:.25rem; margin:2px; font-size:.85rem;
    max-width:220px; min-width:60px;
    overflow:hidden; white-space:nowrap; text-overflow:ellipsis;
    transition: transform 0.15s ease, opacity 0.15s ease;
}
.multi-select .tag:hover { transform: scale(1.05); }
.multi-select .tag span.text {
    overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    display:inline-block; max-width:calc(100% - 16px);
}
.multi-select .tag .remove {
    cursor:pointer; margin-left:6px; font-weight:bold; transition: color 0.2s; flex-shrink:0;
}
.multi-select .tag .remove:hover { color:#ffdddd; }
.multi-select input.input-multi { border:none; outline:none; flex-grow:1; min-width:120px; padding:4px; margin:2px; }
.multi-select .dropdown-list {
    display:none; max-height:200px; overflow-y:auto; border:1px solid #ced4da;
    border-radius:.25rem; background:#fff; position:absolute; top:100%; left:0; width:100%; z-index:1050;
    box-shadow:0 2px 12px rgba(0,0,0,0.15); transition: opacity 0.2s ease;
}
.multi-select .dropdown-item {
    padding:6px 10px; cursor:pointer; transition: background-color 0.2s, color 0.2s;
}
.multi-select .dropdown-item:hover { background-color:#0d6efd; color:white; border-radius:.25rem; }
</style>
</head>
<body>

<h3>üìä –ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ–¥–∞–∂</h3>

<form id="filter-form" class="row g-3 mb-2">
    <div class="col-md-3"><div class="multi-select" id="inn-select"><input type="text" class="input-multi form-control" placeholder="–ò–ù–ù"><div class="dropdown-list"></div></div></div>
    <div class="col-md-3"><div class="multi-select" id="client-select"><input type="text" class="input-multi form-control" placeholder="–ö–ª–∏–µ–Ω—Ç"><div class="dropdown-list"></div></div></div>
    <div class="col-md-3"><div class="multi-select" id="number-select"><input type="text" class="input-multi form-control" placeholder="–ù–æ–º–µ—Ä"><div class="dropdown-list"></div></div></div>
    <div class="col-md-3"><div class="multi-select" id="code-select"><input type="text" class="input-multi form-control" placeholder="–ö–æ–¥"><div class="dropdown-list"></div></div></div>
    <div class="col-md-3"><div class="multi-select" id="item-select"><input type="text" class="input-multi form-control" placeholder="–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞"><div class="dropdown-list"></div></div></div>

    <div class="col-md-3"><div class="multi-select" id="gau-select"><input type="text" class="input-multi form-control" placeholder="–ì–ê–£"><div class="dropdown-list"></div></div></div>
    <div class="col-md-3"><div class="multi-select" id="gau-group-select"><input type="text" class="input-multi form-control" placeholder="–ì–ê–£.–ì—Ä—É–ø–ø–∞"><div class="dropdown-list"></div></div></div>

    <div class="col-md-3"><input class="form-control datepicker" name="date_from" placeholder="–î–∞—Ç–∞ —Å"></div>
    <div class="col-md-3"><input class="form-control datepicker" name="date_to" placeholder="–î–∞—Ç–∞ –ø–æ"></div>

    <div class="col-md-3">
        <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <button type="button" id="reset-btn" class="btn btn-secondary">–°–±—Ä–æ—Å</button>
        <button type="button" id="export-btn" class="btn btn-success">üì• Excel</button>
    </div>
</form>

<div class="scroll-table mt-2">
    <table class="table table-striped table-sm" id="data-table">
        <thead>
            <tr id="header-row"></tr>
            <tr class="filter-row"></tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<nav class="mt-2">
    <ul class="pagination justify-content-center" id="pagination"></ul>
</nav>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.0/dist/js/bootstrap-datepicker.min.js"></script>
<script>
$('.datepicker').datepicker({format:'yyyy-mm-dd',language:'ru',autoclose:true,todayHighlight:true});

let currentPage=1,totalPages=1,sortCol="–î–∞—Ç–∞",sortDir="desc";
const COLUMN_ORDER=[
    "doc_counterparty_inn","doc_counterparty_full_name","–î–∞—Ç–∞","doc_number","doc_department",
    "doc_assigned_manager","inside_doc_author","inside_doc_item_code","inside_doc_item_name",
    "inside_doc_item_quantity","inside_doc_item_full_item_price","–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞.–ì–ê–£",
    "–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞.–ì–ê–£.–ì—Ä—É–ø–ø–∞","Sale_type"
];

// ---------------- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç —Å debounce –∏ –ø–æ–ª–Ω—ã–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏ ----------------
window.linkedValues={};
function debounce(func, wait){ let timeout; return function(...args){ clearTimeout(timeout); timeout=setTimeout(()=>func.apply(this,args), wait); }; }

function setupMultiSelect(containerId, fieldName){
    const container=$(containerId), input=container.find("input.input-multi");
    let selected=[];
    
    function renderTags(){
        container.find(".tag").remove();
        selected.forEach(v=>{
            const tag = $(`
                <span class='tag' data-value='${v}'>
                    <span class="text">${v}</span>
                    <span class='remove'>&times;</span>
                </span>
            `);
            tag.find(".remove").click(()=>{
                selected.splice(selected.indexOf(v),1);
                renderTags(); fetchData(1); updateAllDropdowns();
            });
            tag.insertBefore(input);
        });
        window.linkedValues[fieldName]=selected;
    }

    const loadDropdownDebounced=debounce(function(filter=""){
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤—Å–µ—Ö –ø–æ–ª–µ–π
        const params={q:filter};
        Object.keys(window.linkedValues).forEach(k=>{ params[k+'[]']=window.linkedValues[k]; });
        $.get("/autocomplete/"+fieldName, params, function(data){
            container.find(".dropdown-list").empty();
            data.forEach(item=>{
                if(!selected.includes(item)){
                    const div=$(`<div class='dropdown-item'>${item}</div>`);
                    div.click(()=>{
                        selected.push(item); renderTags(); fetchData(1); updateAllDropdowns();
                        input.val(""); container.find(".dropdown-list").hide();
                    });
                    container.find(".dropdown-list").append(div);
                }
            });
            container.find(".dropdown-list").toggle(data.length>0);
        });
    },250);

    input.on("focus",()=>loadDropdownDebounced());
    input.on("input",()=>loadDropdownDebounced(input.val()));
    input.on("keydown",e=>{
        if(e.key==="Enter" && input.val().trim()){ selected.push(input.val().trim()); renderTags(); fetchData(1); input.val(""); e.preventDefault(); updateAllDropdowns(); }
        else if(e.key==="Backspace" && !input.val() && selected.length){ selected.pop(); renderTags(); fetchData(1); updateAllDropdowns(); }
    });
    $(document).click(e=>{ if(!container.is(e.target) && container.has(e.target).length===0) container.find(".dropdown-list").hide(); });

    return { get:()=>selected, reset:()=>{ selected.length=0; renderTags(); updateAllDropdowns(); } };
}

// –°–æ–∑–¥–∞–µ–º –≤—Å–µ –º—É–ª—å—Ç–∏—Å–µ–ª–µ–∫—Ç—ã
const innSelect=setupMultiSelect("#inn-select","doc_counterparty_inn");
const clientSelect=setupMultiSelect("#client-select","doc_counterparty_full_name");
const numberSelect=setupMultiSelect("#number-select","doc_number");
const codeSelect=setupMultiSelect("#code-select","inside_doc_item_code");
const itemSelect=setupMultiSelect("#item-select","inside_doc_item_name");
const gauSelect=setupMultiSelect("#gau-select","–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞.–ì–ê–£");
const gauGroupSelect=setupMultiSelect("#gau-group-select","–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞.–ì–ê–£.–ì—Ä—É–ø–ø–∞");

const allSelects=[innSelect,clientSelect,numberSelect,codeSelect,itemSelect,gauSelect,gauGroupSelect];
const allFields=["doc_counterparty_inn","doc_counterparty_full_name","doc_number","inside_doc_item_code","inside_doc_item_name","–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞.–ì–ê–£","–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞.–ì–ê–£.–ì—Ä—É–ø–ø–∞"];

function updateAllDropdowns(){
    allFields.forEach((f,i)=>{
        const s=allSelects[i];
        const input=$(s).find("input.input-multi");
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–∞
        const val=input.val();
        loadDropdownDebouncedAll(f, val);
    });
}

const loadDropdownDebouncedAll=debounce(function(field, filter=""){
    const selectMap={
        "doc_counterparty_inn":innSelect,
        "doc_counterparty_full_name":clientSelect,
        "doc_number":numberSelect,
        "inside_doc_item_code":codeSelect,
        "inside_doc_item_name":itemSelect,
        "–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞.–ì–ê–£":gauSelect,
        "–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞.–ì–ê–£.–ì—Ä—É–ø–ø–∞":gauGroupSelect
    };
    const sel=selectMap[field];
    const container=$(sel).find(".multi-select, input");
    const input=$(sel).find("input.input-multi");
    const params={q:filter};
    Object.keys(window.linkedValues).forEach(k=>{ params[k+'[]']=window.linkedValues[k]; });
    $.get("/autocomplete/"+field, params, function(data){
        const dropdown=$(sel).find(".dropdown-list");
        dropdown.empty();
        data.forEach(item=>{ if(!window.linkedValues[field].includes(item)){ const div=$(`<div class='dropdown-item'>${item}</div>`); div.click(()=>{ window.linkedValues[field].push(item); sel.reset(); fetchData(1); updateAllDropdowns(); input.val(""); dropdown.hide(); }); dropdown.append(div); }});
        dropdown.toggle(data.length>0);
    });
},250);

// ---------------- –¢–∞–±–ª–∏—Ü–∞ –∏ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è ----------------
function fetchData(page=1){
    currentPage=page;
    const params=$("#filter-form").serializeArray().reduce((o,i)=>(o[i.name]=i.value,o),{});
    allFields.forEach(f=>{ params[f+'[]']=window.linkedValues[f]; });
    params.page=page; params.sort_col=sortCol; params.sort_dir=sortDir;
    $.get("/data",params,function(res){
        const data=res.data; totalPages=res.total_pages||1;
        if(!data.length){ $("#data-table tbody").html("<tr><td colspan='14'>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>"); return; }
        $("#header-row").html(COLUMN_ORDER.map(h=>`<th data-col='${h}'>${h}${h===sortCol?(sortDir==='asc'?' ‚ñ≤':' ‚ñº'):''}</th>`).join(""));
        $("#data-table thead tr.filter-row").html(COLUMN_ORDER.map(h=>`<th><input type='text' class='form-control form-control-sm column-filter' data-field='${h}' placeholder='–§–∏–ª—å—Ç—Ä...'></th>`).join(""));
        $("#data-table tbody").html(data.map(r=>"<tr>"+COLUMN_ORDER.map(h=>`<td>${r[h]??''}</td>`).join("")+"</tr>").join(""));
        let start=Math.max(1,currentPage-2),end=Math.min(totalPages,currentPage+2); let pages="";
        for(let i=start;i<=end;i++) pages+=`<li class='page-item ${i===currentPage?'active':''}'><a class='page-link' href='#' onclick='fetchData(${i})'>${i}</a></li>`;
        $("#pagination").html(`<li class='page-item ${currentPage===1?'disabled':''}'><a class='page-link' href='#' onclick='fetchData(${currentPage-1})'>–ù–∞–∑–∞–¥</a></li>`+pages+`<li class='page-item ${currentPage===totalPages?'disabled':''}'><a class='page-link' href='#' onclick='fetchData(${currentPage+1})'>–í–ø–µ—Ä—ë–¥</a></li>`);
    });
}

$("#filter-form").on("submit",e=>{ e.preventDefault(); fetchData(1); });
$("#reset-btn").on("click",()=>{
    $("#filter-form")[0].reset();
    allSelects.forEach(s=>s.reset());
    fetchData(1);
});
$("#export-btn").on("click", () => {
    const form = $("#filter-form").clone(); // –∫–ª–æ–Ω–∏—Ä—É–µ–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å —Ç–µ–∫—É—â–∏–π –≤–∏–¥
    allFields.forEach(f => {
        // –¥–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è multi-select
        window.linkedValues[f].forEach(v => {
            form.append(`<input type="hidden" name="${f}[]" value="${v}">`);
        });
    });
    // —Ñ–æ—Ä–º–∏—Ä—É–µ–º query string –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
    const query = form.serialize();
    window.open("/export?" + query, "_blank");
});
$(document).on("click","th[data-col]",function(){ const c=$(this).data("col"); if(c){ sortCol=c; sortDir=(sortDir==='asc'?'desc':'asc'); fetchData(1); } });
$(document).on("input",".column-filter",function(){
    const filters={};
    $(".column-filter").each(function(){ const val=$(this).val().trim(); if(val) filters[$(this).data("field")]=val.toLowerCase(); });
    $("#data-table tbody tr").each(function(){
        const row=$(this); let visible=true;
        for(const field in filters){ const cellText=row.find(`td:nth-child(${COLUMN_ORDER.indexOf(field)+1})`).text().toLowerCase(); if(!cellText.includes(filters[field])){ visible=false; break; } }
        row.toggle(visible);
    });
});

fetchData();
</script>
</body>
</html>
